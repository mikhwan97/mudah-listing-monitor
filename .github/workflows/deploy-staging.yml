name: ğŸš€ Deploy to Local Staging

on:
  push:
    branches:
      - staging  # run when code is pushed directly to staging
  pull_request:
    branches:
      - staging  # run when a PR targeting staging is closed (merged)
    types:
      - closed   # only trigger when PR is closed (not on open/sync)

jobs:
  deploy:
    if: github.event.pull_request.merged == true || github.event_name == 'push'
    name: Deploy to Local Staging
    runs-on: self-hosted  # use your Mac runner
    steps:
      - name: ğŸ§¹ Cleanup old workspace
        run: find ${{ github.workspace }} -mindepth 1 -maxdepth 1 ! -name 'data' -exec rm -rf {} +

      - name: ğŸ›ï¸ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ‹ Build Docker images
        run: docker compose build

      - name: ğŸš€ Run Docker containers
        run: docker compose up -d

      - name: âœ… Show running containers
        run: docker ps
